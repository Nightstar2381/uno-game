<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>UNO Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f0f8ff;
      color: #000;
      padding-top: 80px;
      font-family: 'Segoe UI', sans-serif;
    }
    .uno-card-img {
      width: 70px;
      height: auto;
      margin: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .uno-card-img:hover {
      transform: scale(1.1);
    }
    #top-card, #draw-pile {
      width: 80px;
      height: auto;
      cursor: pointer;
    }
    .profile-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #0d6efd;
    }
  </style>
</head>
<body onload="loadProfilePic()">
  <nav class="navbar fixed-top px-3 bg-light">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">UNO Game</span>
      <div>
        <a href="index.html" class="nav-link d-inline px-2">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      </div>
    </div>
  </nav>

  <div class="container text-center">
    <div id="profile-container" class="mb-2"></div>
    <h4>‡∏´‡πâ‡∏≠‡∏á: <span id="room-name"></span></h4>
    <div class="d-flex justify-content-center align-items-center gap-3 my-3">
      <img id="draw-pile" src="https://raw.githubusercontent.com/Nightstar2381/uno-cards/main/back.png" alt="Draw Pile" onclick="drawCard()" />
      <img id="top-card" src="https://raw.githubusercontent.com/Nightstar2381/uno-cards/main/wild.png" alt="Top Card" />
    </div>
    <div>‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="countdown" class="fw-bold text-danger">‚Äì</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
    <p class="mt-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="scoreboard">-</span></p>
    <div class="mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="player-list"></span></div>
    <div>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏Ç‡∏≠‡∏á: <span id="current-turn"></span></div>

    <div id="loading" class="my-3">
      <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div id="hand" class="d-none mb-4"></div>

    <button class="btn btn-warning" onclick="callUNO()">‡∏Å‡∏î UNO!</button>

    <div class="mt-4">
      <input type="text" id="chat-input" class="form-control mb-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
      <button class="btn btn-secondary" onclick="sendChat()">‡∏™‡πà‡∏á</button>
      <div id="chat-box" class="mt-3 text-start"></div>
    </div>
  </div>

  <!-- Game Over Summary Modal -->
  <div class="modal fade" id="gameOverModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header">
          <h5 class="modal-title">üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h5>
        </div>
        <div class="modal-body">
          <h4 id="winner-name" class="text-success mb-3">‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: </h4>
          <table class="table table-bordered">
            <thead><tr><th>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</th></tr></thead>
            <tbody id="summary-body"></tbody>
          </table>
          <button class="btn btn-success me-2" onclick="startRematch()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
          <button class="btn btn-secondary" onclick="location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io("https://uno-server-vea3.onrender.com");
    const query = new URLSearchParams(location.search);
    const username = query.get("username");
    const password = query.get("password");
    const room = query.get("room");

    document.getElementById("room-name").textContent = room;

    const cardImageURL = (card) => {
      if (!card || !card.color || !card.value) return "";
      let color = card.color.toLowerCase();
      let value = card.value.toLowerCase().replace('+', 'plus');
      return `https://raw.githubusercontent.com/Nightstar2381/uno-cards/main/${color}_${value}.png`;
    };

    function loadProfilePic() {
      const pic = localStorage.getItem("profilePic");
      if (pic) {
        const img = document.createElement("img");
        img.src = pic;
        img.alt = "Profile";
        img.className = "profile-img mb-2";
        document.getElementById("profile-container").appendChild(img);
      }
    }

    socket.emit("joinRoom", { username, password, room });

    socket.on("joinedRoom", data => {
      document.getElementById("loading").style.display = "none";
      document.getElementById("hand").classList.remove("d-none");
      updatePlayers(data.players, data.currentTurn);
      renderHand(data.yourCards);
    });

    socket.on("updateHand", renderHand);
    socket.on("updatePlayers", ({ players, currentTurn }) => updatePlayers(players, currentTurn));
    socket.on("updateTurn", turn => {
      document.getElementById("current-turn").textContent = turn;
    });

    socket.on("topCard", card => {
      const img = document.getElementById("top-card");
      img.src = cardImageURL(card);
      img.alt = `${card.color} ${card.value}`;
    });

    socket.on("scoreUpdate", scores => {
      const text = Object.entries(scores).map(([n, s]) => `${n}: ${s}`).join(" | ");
      document.getElementById("scoreboard").textContent = text;
      window.latestScores = scores;
    });

    socket.on("gameOver", winner => {
      document.getElementById("winner-name").textContent = `‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ${winner}`;
      const tbody = document.getElementById("summary-body");
      const scores = window.latestScores || {};
      tbody.innerHTML = Object.entries(scores)
        .map(([name, score]) => `<tr><td>${name}</td><td>${score}</td></tr>`)
        .join("");
      new bootstrap.Modal(document.getElementById("gameOverModal")).show();
    });

    function renderHand(cards) {
      const handDiv = document.getElementById("hand");
      handDiv.innerHTML = "";
      cards.forEach((card, index) => {
        const img = document.createElement("img");
        img.src = cardImageURL(card);
        img.alt = `${card.color} ${card.value}`;
        img.className = "uno-card-img";
        img.onclick = () => {
          socket.emit("playCard", index);
        };
        handDiv.appendChild(img);
      });
    }

    function updatePlayers(players, currentTurn) {
      const listSpan = document.getElementById("player-list");
      listSpan.innerHTML = players.map(name =>
        name === currentTurn ? `<strong>${name}</strong>` : name
      ).join(", ");
    }

    function callUNO() {
      socket.emit("callUNO");
      alert("‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î UNO ‡πÅ‡∏•‡πâ‡∏ß!");
    }

    function sendChat() {
      const input = document.getElementById("chat-input");
      const msg = input.value.trim();
      if (msg) socket.emit("chat", msg);
      input.value = "";
    }

    function drawCard() {
      socket.emit("drawCard");
    }

    function startRematch() {
      socket.emit("rematchRequest");
      bootstrap.Modal.getInstance(document.getElementById("gameOverModal")).hide();
    }
  </script>
</body>
</html>
